# Disable directory listing
Options -Indexes
ServerSignature Off

<IfModule mod_rewrite.c>
  RewriteEngine On

  # Remove leading www and enforce HTTPS in one hop
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

  # Enforce HTTPS (also consider reverse proxies)
  RewriteCond %{HTTPS} !=on [OR]
  RewriteCond %{HTTP:X-Forwarded-Proto} !https
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # Block direct access to sensitive directories
  RewriteRule ^(migrations|src|vendor|\.git|\.github|tests|docs)(/|$) - [F,L]
</IfModule>

# Deny hidden files (dotfiles)
<FilesMatch "^\.">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Deny from all
  </IfModule>
</FilesMatch>

# Deny specific sensitive files
<FilesMatch "^(?:\.env|composer\.(?:json|lock)|README(?:\.md)?|phpunit\.xml(?:\.dist)?|\.gitignore)$">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Deny from all
  </IfModule>
</FilesMatch>

# Security headers
<IfModule mod_headers.c>
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "no-referrer-when-downgrade"
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
</IfModule>

# Custom error pages (optional)
ErrorDocument 403 "Forbidden"
ErrorDocument 404 "Not Found"
