# Cron Jobs Setup Guide

## Overview

This project requires **2 automated daily cron jobs**:

1. **Quiet Hours Notification** (23:00) - Announces bot maintenance period
2. **Generate Golden Number** (00:00) - Creates new daily challenge and notifies users

## Prerequisites

- Server access with cron/crontab capabilities
- PHP CLI installed (check: `php -v`)
- Timezone configured in Admin Panel
- Write permissions for `storage/logs/` directory

## Step 1: Configure Timezone

**Important:** Set your timezone in the Admin Panel before setting up cron jobs.

1. Visit `/admin` in your browser
2. Click **Edit Settings**
3. Select your timezone (e.g., `Asia/Tehran` for Iran, `America/New_York` for EST, `Europe/London` for UK)
4. Click **Save Settings**

This ensures cron jobs run at the correct local time.

## Step 2: Cron Job #1 - Quiet Hours Notification (23:00)

### Purpose
Sends a notification to all users at 23:00 (11:00 PM) announcing that the bot will be inactive for maintenance from 23:00 to 00:00 (midnight).

### Cron Command
```bash
0 23 * * * php /path/to/project/public/cron/quiet-hours-start.php >> /path/to/project/storage/logs/cron-quiet.log 2>&1
```

### Breaking Down the Command
- `0 23 * * *` - Run at 23:00 (11 PM) every day
  - `0` = minute (0)
  - `23` = hour (23 = 11 PM)
  - `* * *` = every day of month, every month, every day of week
- `php /path/to/.../quiet-hours-start.php` - Execute the PHP script
- `>> .../cron-quiet.log` - Append output to log file
- `2>&1` - Redirect errors to the same log file

### What It Does
1. Sends a notification message to all registered users
2. Informs them the bot will be inactive from 23:00 to 00:00
3. Users can complete ongoing games but cannot start new ones during this period

### Example Message Sent to Users
```
🌙 Bot Maintenance Notice

The bot will be inactive from 23:00 to 00:00 for daily maintenance.

⚠️ You cannot start new games during this time.
✅ Ongoing games can still be completed.

🕐 We'll be back at 00:00 with a fresh new Golden Number!
See you soon! 🎲
```

## Step 3: Cron Job #2 - Generate Golden Number (00:00)

### Purpose
Generates a new 7-digit golden number at midnight (00:00) using OpenAI and broadcasts it to all users.

### Cron Command
```bash
0 0 * * * php /path/to/project/public/cron/generate-golden.php >> /path/to/project/storage/logs/cron-golden.log 2>&1
```

### Breaking Down the Command
- `0 0 * * *` - Run at 00:00 (midnight) every day
  - `0` = minute (0)
  - `0` = hour (0 = midnight)
  - `* * *` = every day of month, every month, every day of week
- `php /path/to/.../generate-golden.php` - Execute the PHP script
- `>> .../cron-golden.log` - Append output to log file
- `2>&1` - Redirect errors to the same log file

### What It Does
1. Generates a new 7-digit golden number using OpenAI API (or random fallback if API fails)
2. Saves the number to the `golden_numbers` database table
3. Sends an announcement message to all registered users
4. Marks the golden number as `announced`

### Example Message Sent to Users
```
The new golden number is ready! Try your luck and start a new game with /startgame and roll up to 7 times.
```
*(Message is generated by ChatGPT for variety)*

## Step 4: Setup Instructions for Linux/Ubuntu

### 1. Open Crontab Editor
```bash
crontab -e
```

### 2. Add Both Cron Jobs
Add these two lines to your crontab file:

```bash
# Quiet Hours Notification (23:00)
0 23 * * * php /var/www/html/mindroll/public/cron/quiet-hours-start.php >> /var/www/html/mindroll/storage/logs/cron-quiet.log 2>&1

# Generate Golden Number (00:00)
0 0 * * * php /var/www/html/mindroll/public/cron/generate-golden.php >> /var/www/html/mindroll/storage/logs/cron-golden.log 2>&1
```

**Important:** Replace `/var/www/html/mindroll` with your actual project path.

**Example Paths:**
- cPanel: `/home/username/public_html/mindroll`
- Shared hosting: `/home/yourusername/domains/yourdomain.com/public_html`
- VPS: `/var/www/mindroll` or `/var/www/html/mindroll`

### 3. Save and Exit
- **nano editor**: Press `Ctrl + X`, then `Y`, then `Enter`
- **vim editor**: Press `ESC`, type `:wq`, press `Enter`

### 4. Verify Cron Jobs
List all cron jobs to verify they were added:
```bash
crontab -l
```

You should see both cron jobs listed.

## Step 5: Setup Instructions for Windows (Task Scheduler)

### Task #1: Quiet Hours Notification (23:00)

1. Open **Task Scheduler** (search in Start Menu)
2. Click **Create Basic Task**
3. **Name:** `Bot Quiet Hours Notification`
4. **Trigger:** Daily at **23:00** (11:00 PM)
5. **Action:** Start a program
   - **Program/script:** `C:\laragon\bin\php\php-8.2\php.exe`
   - **Add arguments:** `D:\Programming\WebSrv\laragon\www\mindroll\public\cron\quiet-hours-start.php`
   - **Start in (optional):** `D:\Programming\WebSrv\laragon\www\mindroll`
6. Click **Finish**

### Task #2: Generate Golden Number (00:00)

1. Click **Create Basic Task** again
2. **Name:** `Bot Generate Golden Number`
3. **Trigger:** Daily at **00:00** (midnight)
4. **Action:** Start a program
   - **Program/script:** `C:\laragon\bin\php\php-8.2\php.exe`
   - **Add arguments:** `D:\Programming\WebSrv\laragon\www\mindroll\public\cron\generate-golden.php`
   - **Start in (optional):** `D:\Programming\WebSrv\laragon\www\mindroll`
5. Click **Finish**

**Important Notes:**
- Replace `C:\laragon\bin\php\php-8.2\php.exe` with your actual PHP path
  - **Laragon:** `C:\laragon\bin\php\php-8.x\php.exe`
  - **XAMPP:** `C:\xampp\php\php.exe`
  - **WAMP:** `C:\wamp64\bin\php\php8.x\php.exe`
- Replace the project path with your actual installation directory

## Step 6: Verify Cron Jobs Are Working

### Check Quiet Hours Log
```bash
tail -f storage/logs/cron-quiet.log
```

**Expected Output:**
```
[2025-10-17 23:00:01] Quiet hours notification sent to 125 users (2 failed)
```

### Check Generate Golden Number Log
```bash
tail -f storage/logs/cron-golden.log
```

**Expected Output:**
```
[2025-10-18 00:00:03] Golden number generated: 3847261 | Sent to 127 users (4 failed)
```

### On Windows
Navigate to `storage/logs/` folder and open the log files in a text editor.

## Step 7: Test Manually Before Setting Up Cron

**Important:** Always test the scripts manually before adding them to cron.

### Test Quiet Hours Script
```bash
cd /path/to/project
php public/cron/quiet-hours-start.php
```

**Success Output:**
```
Quiet hours notification sent to 150 users (2 failed)
```

### Test Generate Golden Number Script
```bash
cd /path/to/project
php public/cron/generate-golden.php
```

**Success Output:**
```
Golden number generated: 5732819 | Sent to 148 users (4 failed)
```

### On Windows (Laragon/XAMPP)
```cmd
cd D:\Programming\WebSrv\laragon\www\mindroll
C:\laragon\bin\php\php-8.2\php.exe public/cron/quiet-hours-start.php
C:\laragon\bin\php\php-8.2\php.exe public/cron/generate-golden.php
```

## Troubleshooting

### Problem 1: Cron Jobs Not Running

**Solution:**
- Verify PHP CLI is installed: `php -v`
- Use full path to PHP binary:
  - Linux: `/usr/bin/php` (find with `which php`)
  - Windows: `C:\laragon\bin\php\php-8.2\php.exe`
- Check cron service is running (Linux):
  ```bash
  sudo systemctl status cron
  ```

### Problem 2: Permission Denied Errors

**Solution (Linux only):**
```bash
chmod +x public/cron/quiet-hours-start.php
chmod +x public/cron/generate-golden.php
chmod -R 755 storage/logs/
chown -R www-data:www-data storage/logs/
```

### Problem 3: Wrong Timezone / Jobs Run at Wrong Time

**Solution:**
1. Go to `/admin` in your browser
2. Click **Edit Settings**
3. Select correct timezone from dropdown:
   - Iran: `Asia/Tehran`
   - USA EST: `America/New_York`
   - USA PST: `America/Los_Angeles`
   - UK: `Europe/London`
   - India: `Asia/Kolkata`
4. Save settings and wait for next scheduled run

### Problem 4: No Messages Being Sent

**Solution:**
- Verify `TELEGRAM_BOT_TOKEN` in `.env` is correct
- Check that users exist in the `users` database table
- Review log files: `storage/logs/cron-*.log`
- Test bot token with Telegram API:
  ```bash
  curl https://api.telegram.org/bot<YOUR_TOKEN>/getMe
  ```

### Problem 5: Script Runs But Throws Errors

**Solution:**
- Check database connection in `.env`
- Ensure all database tables exist (run `migrations/game_complete.sql`)
- Review PHP error logs:
  - Linux: `/var/log/apache2/error.log` or `/var/log/nginx/error.log`
  - Laragon: `laragon/logs/apache_error.log`

## Important Notes

1. **Timezone is Critical:** Always set timezone in Admin Panel before configuring cron jobs
2. **Test First:** Manually test scripts before adding to cron
3. **Monitor Logs:** Regularly check `storage/logs/cron-*.log` for issues
4. **Rate Limiting:** Scripts include 50ms delay between messages to avoid Telegram rate limits
5. **Quiet Hours Control:** You can manually enable/disable quiet hours from Admin Panel

## Quick Reference

| Cron Job | Time | Script | Purpose |
|----------|------|--------|----------|
| **Quiet Hours** | 23:00 | `quiet-hours-start.php` | Announce maintenance period |
| **Generate Golden** | 00:00 | `generate-golden.php` | Create daily challenge |

## Daily Schedule After Setup

- **23:00** → Quiet hours notification sent to all users
- **23:00-00:00** → New games blocked (ongoing games can finish)
- **00:00** → New golden number generated and announced
- **00:00+** → New games allowed, fresh daily challenge begins

## Example: Complete Setup for Linux VPS

```bash
# 1. Edit crontab
crontab -e

# 2. Add these lines (replace paths with yours)
0 23 * * * php /var/www/mindroll/public/cron/quiet-hours-start.php >> /var/www/mindroll/storage/logs/cron-quiet.log 2>&1
0 0 * * * php /var/www/mindroll/public/cron/generate-golden.php >> /var/www/mindroll/storage/logs/cron-golden.log 2>&1

# 3. Save and exit (Ctrl+X, Y, Enter in nano)

# 4. Verify
crontab -l

# 5. Check logs after scheduled time
tail -f /var/www/mindroll/storage/logs/cron-*.log
```

## Example: cPanel Cron Jobs Setup

1. Login to cPanel
2. Find **Cron Jobs** under Advanced section
3. For each job, set:
   - **Minute:** 0
   - **Hour:** 23 (for quiet hours) or 0 (for golden number)
   - **Day, Month, Weekday:** *
   - **Command:**
     ```bash
     php /home/username/public_html/mindroll/public/cron/quiet-hours-start.php >> /home/username/public_html/mindroll/storage/logs/cron-quiet.log 2>&1
     ```
4. Click **Add New Cron Job**

---

**Setup Complete!** 🚀 Your bot will now automatically handle quiet hours and daily golden number generation.
