# Telegram Dice Game Bot (PHP 8 + MySQL) — Full Setup & Deployment Guide

This project is a Telegram dice game bot with daily points and an hourly “Golden Number” generated via OpenAI. It is built in PHP (class-based, SOLID-ish layering) and uses MySQL for persistence.

## Features
- **Daily points**: each user gets 100 points per day (configurable).
- **Dice roll**: each roll costs 5 points (configurable) using Telegram `sendDice`.
- **Golden Number**: generated hourly via OpenAI; correct guess awards +100 points.
- **Buttons**: Start, Leaderboard, Status.
- **Commands**: `/start`, `/guess 123`, `/leaderboard`, `/status`.
- **Admin panel**: Tailwind dashboard with first-run admin registration.

## Requirements
- **PHP** 8.1+ with PDO MySQL extension
- **MySQL/MariaDB**
- **Composer**
- **Web server**: Apache (with `mod_rewrite`, `AllowOverride All`) or Nginx (see config below)
- **Valid HTTPS** (SSL certificate) for Telegram webhook

## Folder Structure
```
public/
  game.php
  cron/generate-golden.php
src/
  App.php, Controllers/, Services/, Repositories/, Models/
admin/
  index.php
migrations/
  game.sql
.env.example
composer.json
README.md
```

## Step-by-step Setup

1) Upload/Clone the project on your host (prefer docroot → `public/`).

2) Install dependencies
```bash
composer install
```

3) Database (v2 schema)
- IMPORTANT: v2 schema is different and will DROP existing tables defined in the migration file.
- Backup if you need old data.
- Import `migrations/game.sql` via phpMyAdmin or CLI:
```bash
mysql -u <DB_USER> -p -h <DB_HOST> <DB_NAME> < migrations/game.sql
```

4) Configure environment
- Copy `.env.example` → `.env` and fill values:
```
TELEGRAM_BOT_TOKEN=123456:ABC...
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-5
DB_HOST=localhost
DB_NAME=telegram_game
DB_USER=root
DB_PASS=
ADMIN_PASSWORD_HASH=
DAILY_POINTS=100   # legacy, not used in v2 logic
DICE_COST=0        # recommended 0 for v2; scores award coins
LOG_REQUESTS=false
```
- `ADMIN_PASSWORD_HASH` (optional) enables login with username `admin`.
  Generate hash:
```bash
php -r "echo password_hash('YourStrongPassword', PASSWORD_BCRYPT), PHP_EOL;"
```

5) Web server & HTTPS
- Apache: enable `mod_rewrite`, set `AllowOverride All`.
- Docroot:
  - If docroot = `public/` → webhook URL ends with `/game.php`.
  - If docroot = project root → webhook URL ends with `/public/game.php`.
- `.htaccess` already enforces HTTPS, removes www, disables directory listing.

6) BotFather — create bot & set webhook
- In Telegram, open `@BotFather` → `/newbot` → get token.
- Set webhook (example domain `mindroll.misterbr.ir`):
```
# docroot = public
https://api.telegram.org/bot<YOUR_TOKEN>/setWebhook?url=https://mindroll.misterbr.ir/game.php&drop_pending_updates=true
# docroot = root
https://api.telegram.org/bot<YOUR_TOKEN>/setWebhook?url=https://mindroll.misterbr.ir/public/game.php&drop_pending_updates=true
```
- Set description and commands:
```
/help - Show help
/status - Show coins, session state, wallet
/startgame - Start a new game session
/next - Roll next dice (up to 7)
/wallet - Set or update your Worldcoin wallet address
/deposit - Show deposit address
/withdraw - Create a withdrawal request
```

7) Admin Panel
- Visit `/admin`.
- First‑run registration appears if there is no admin user.
- Manage settings (in DB `settings`):
  - `start_coins` (default 1000)
  - `withdraw_min_balance` (default 1001)
  - `deposit_wallet_address` (string)
  - `sleep_ms_between_rolls` (default 3000)
  - `quiet_hours_start` (23:00), `quiet_hours_end` (00:00)
  - `score_match_3`, `score_match_5`, `score_all_unordered`, `score_exact_ordered`
  - `openai_model`

8) Cron (midnight daily)
- Generate the new 7‑digit Golden Number and broadcast a message: “The new number is ready! Try your luck!”.
```cron
0 0 * * * php /path/to/project/public/cron/generate-golden.php > /dev/null 2>&1
```

9) Commands & Game Flow
- `/startgame` → create a new session for today’s golden number (blocked 23:00–00:00).
- `/next` → roll next dice (1–6), append to session, sleep `sleep_ms_between_rolls` ms, reply progress until 7 rolls.
- When 7 values are collected, compute score and add coins (World Coin) to the user:
  - match 3 digits (unordered) → `score_match_3`
  - match 5 digits (unordered) → `score_match_5`
  - all 7 digits, wrong order → `score_all_unordered`
  - exact 7‑digit ordered match → `score_exact_ordered` (10,000 by default)
- On exact match, send a congratulatory text generated by ChatGPT.

10) Wallet / Deposit / Withdraw
- `/wallet` → ask for Worldcoin address and save/update `wallet_address` in `users`.
- `/deposit` → show deposit address from settings.
- `/withdraw` → ask for amount, create `withdraw_requests` row, call a stub API, reply success/failed.
- Users start with `start_coins=1000`; minimum to withdraw is `withdraw_min_balance=1001`.

## Database (summary)
- `users`: coins, wallet_address (unique), timestamps
- `golden_numbers`: number (CHAR(7)), valid_date, announced
- `game_sessions`: user, golden, 7 digits, rolls_count, finished, score_awarded
- `rolls`: session_id, user_id, result (1–6), step_index
- `withdraw_requests`: user_id, amount, status, api_response
- `settings`: key/value

## Notes
- UX is commands only; do not rely on inline keyboards.
- You can enable basic webhook logging with `LOG_REQUESTS=true` → logs written to `storage/logs/`.
- Currency name shown to users: “World Coin”.

## Troubleshooting
- Webhook not invoked: check `getWebhookInfo`, ensure HTTPS and correct docroot URL.
- 500 errors: ensure `vendor/` exists, PHP version, DB credentials in `.env`.
- DB errors: re‑import `migrations/game.sql`; confirm privileges.
- Cron not running: verify crontab path and PHP binary; check server logs.
- Set webhook as in step 6.
- Add Cron in cPanel as in step 8.

### B) VPS (Ubuntu) + Apache
- Install Apache, PHP 8.1+, MySQL, Composer.
- VirtualHost example (docroot to `public/`):
```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    Redirect permanent / https://yourdomain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName yourdomain.com
    DocumentRoot /var/www/project/public
    <Directory /var/www/project/public>
        AllowOverride All
        Require all granted
    </Directory>
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/yourdomain.com/privkey.pem
</VirtualHost>
```

### C) VPS (Ubuntu) + Nginx
- Sample server block (docroot to `public/`):
```nginx
server {
  listen 80;
  server_name yourdomain.com www.yourdomain.com;
  return 301 https://yourdomain.com$request_uri;
}

server {
  listen 443 ssl http2;
  server_name yourdomain.com;
  root /var/www/project/public;
  index index.php;

  ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/run/php/php8.2-fpm.sock;
  }

  # Block sensitive files
  location ~ /\.(env|git|htaccess|gitignore) { deny all; }
}
```

### D) Local (Laragon/XAMPP)
- Place project in the web root (e.g., `laragon/www/mindroll`).
- Create DB, import `migrations/game.sql`.
- Copy `.env.example` → `.env` and set credentials.
- `composer install`.
- Access `http://mindroll.test` (Laragon) or `http://localhost/mindroll/public`.

## API Endpoints
| Method | Endpoint                | Description                                  |
| ------ | ----------------------- | -------------------------------------------- |
| POST   | `/webhook`              | Telegram webhook (actually `public/game.php`) |
| POST   | `/api/roll`             | Internal endpoint for rolling dice            |
| POST   | `/cron/generate-golden` | Cron job for generating hourly golden number  |
| GET    | `/admin`                | Admin login/dashboard                         |

## Security & Best Practices
- Keep secrets in `.env` (already `.gitignore`).
- Ensure HTTPS and valid certificate (Telegram requires it).
- Apache: `mod_rewrite` + `AllowOverride All`; Nginx: use server block above.
- Our `.htaccess` enforces HTTPS, removes `www`, disables directory listing, and blocks sensitive files.
- Sanitize inputs; use prepared statements (already used via PDO prepared statements).

## Troubleshooting
- **Webhook not triggered**: check `getWebhookInfo`, verify URL is HTTPS and reachable; confirm docroot path to `public/`.
- **500 errors**: check `vendor/` installed, PHP version, DB credentials in `.env`.
- **DB errors**: ensure DB exists and `migrations/game.sql` imported; verify privileges.
- **Admin panel not loading**: ensure correct docroot. If docroot is `public/`, move `admin/` under `public/` or set a separate vhost with root at project directory.
- **OpenAI errors**: if API fails, fallback 3-digit number is used automatically.

## License
MIT (see `composer.json`).
