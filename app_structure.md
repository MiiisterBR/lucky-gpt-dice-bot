# Project Design — Telegram Golden Dice Bot v2 (PHP + MySQL + OpenAI)

## Overview

- Daily “Golden Number” with 7 digits (generated by OpenAI at midnight).
- Users hold in‑app balance named “World Coin”.
- Users start with 1,000 coins; minimum balance to withdraw is 1,001 coins.
- Game sessions produce 7 dice values. Scoring compares the 7 values to the daily golden number.
- UX is command‑based only (no inline keyboards). All code, texts, and messages are in English.

## Commands & Reply Keyboard

**Persistent Reply Keyboard** (buttons at bottom of chat):
- Row 1: **Start** (or **Next** if session active), **Status**
- Row 2: **Leaderboard**, **Wallet**
- Row 3: **Deposit**, **Withdraw**

Buttons trigger commands:
- `/help` — Show help and available commands.
- `/status` — Show coins, current session state (rolled count, digits so far), and wallet address.
- `/startgame` (button: **Start**) — Start a new 7-dice session (blocked during quiet hours 23:00–00:00; ongoing sessions can finish).
- `/next` (button: **Next**) — Roll next dice for the active session (up to 7 rolls, with configurable sleep after each roll).
- `/wallet` — View current wallet address.
- `/wallet <ADDRESS>` — Set or update Worldcoin wallet address (stored in `users.wallet_address`).
- `/deposit` — Show deposit address configured in Admin settings.
- `/withdraw <AMOUNT>` — Create a withdraw request; validates balance, calls a test API, and replies success/error.
- `/leaderboard` — Show top 7 winners and 7 lowest balances.

## Scoring Rules

- Let G be the 7‑digit golden number, and R be the 7 results of the user’s session.
- If 3 digits of R exist in G (order irrelevant) → award `score_match_3` (default 10).
- If 5 digits of R exist in G (order irrelevant) → award `score_match_5` (default 15).
- If all 7 digits exist but order is not exact → award `score_all_unordered` (default 30).
- If all 7 digits match exactly and in the same order → award `score_exact_ordered` (default 10,000).
- Coins name: “World Coin”.

## Daily Golden Number & Quiet Hours

- A new 7‑digit golden number is generated daily at 00:00 via cron or manual trigger in Admin.
- Quiet hours: 23:00–00:00
  - Users cannot start a new session between 23:00 and 00:00.
  - Ongoing sessions can be completed.
  - If a user tries to start during quiet hours, reply “Come back after 00:00.”
- When a new number is generated, broadcast: “The new number is ready! Try your luck!”.
- If a user hits the exact 7‑digit ordered match, send a congratulatory message generated by ChatGPT.

## Technical Details

- Language: PHP 8+
- Database: MySQL/MariaDB
- Entry point: `public/game.php` (Telegram webhook)
- Architecture: Controllers, Services, Repositories, Models (SOLID/SoC)
- UX: Command-based with persistent **Reply Keyboard** (no inline keyboards).
- Sleep between rolls: `sleep_ms_between_rolls` (default 3000 ms), configurable in Admin settings.
- All code, comments, and bot messages in English.

## Database Schema (MySQL)

Implemented in `migrations/game.sql` (re‑import to apply v2):

- `users`: `id`, `username`, `first_name`, `last_name`, `coins` (default 1000), `wallet_address` (unique nullable), timestamps
- `golden_numbers`: `id`, `generated_at`, `number` (CHAR(7)), `valid_date`, `source`, `announced`, timestamps
- `game_sessions`: `id`, `user_id`, `golden_id`, `result_digits` (CHAR(7)), `rolls_count`, `finished`, `score_awarded`, timestamps
- `rolls`: `id`, `session_id`, `user_id`, `result` (1–6), `step_index` (1–7), `cost`, `created_at`
- `withdraw_requests`: `id`, `user_id`, `amount`, `status` (pending/success/failed), `api_response`, timestamps
- `admin_users`: `id`, `username`, `password_hash`, timestamps
- `settings`: key/value store

Seeded settings (can be changed in Admin):
- `openai_model=gpt-5`
- `start_coins=1000`, `withdraw_min_balance=1001`, `deposit_wallet_address` (string)
- `sleep_ms_between_rolls=3000`, `quiet_hours_start=23:00`, `quiet_hours_end=00:00`
- `score_match_3=10`, `score_match_5=15`, `score_all_unordered=30`, `score_exact_ordered=10000`
- `dice_cost=0`, `log_requests=false`

## Folder Structure

```
telegram-game-bot/
├─ public/
│  ├─ game.php
│  └─ cron/generate-golden.php        # run at 00:00 daily
├─ src/
│  ├─ App.php
│  ├─ Controllers/
│  │  └─ TelegramController.php
│  ├─ Services/
│  │  ├─ TelegramService.php
│  │  ├─ OpenAIService.php
│  │  ├─ GameService.php
│  │  └─ UserService.php
│  ├─ Repositories/
│  │  ├─ UserRepository.php
│  │  └─ GoldenRepository.php
│  └─ Models/
│     ├─ User.php
│     ├─ Roll.php
│     └─ Guess.php (legacy; not used in v2)
├─ admin/
│  └─ index.php                      # Dashboard & Settings
├─ migrations/
│  └─ game.sql
├─ .env
├─ composer.json
└─ README.md
```

## Game Flow Summary

1) User taps **Start** or sends `/startgame` (blocked 23:00–00:00). A new session is created for today's golden number. The first dice roll happens immediately.
2) Reply keyboard changes: **Start** button becomes **Next**.
3) User taps **Next** or sends `/next` up to 6 more times (7 total rolls). Each call:
   - Rolls a dice (result 1–6)
   - Appends result to session's `result_digits`
   - Sleeps `sleep_ms_between_rolls` ms (default 3000)
   - Replies with progress: "Roll 3/7: 4 | Progress: 2, 5, 4"
4) When 7 values are collected:
   - Compute score according to Scoring Rules
   - Add coins to user's balance
   - If exact ordered match (all 7 digits in correct order), generate a personalized congratulatory message via ChatGPT
   - Mark session as finished
   - Reply keyboard changes: **Next** button becomes **Start** again

## Wallet / Deposit / Withdraw

- **`/wallet`**: View current Worldcoin wallet address or prompt user to set it if not yet configured.
- **`/wallet <ADDRESS>`**: Set or update wallet address. Stored in `users.wallet_address` (unique).
- **`/deposit`**: Display the deposit address from Admin settings (`deposit_wallet_address`).
- **`/withdraw <AMOUNT>`**: 
  1. Validate user has minimum balance (`withdraw_min_balance`, default 1001)
  2. Validate amount > 0 and ≤ user's coins
  3. Create a new row in `withdraw_requests` (status='pending')
  4. Call a stub test API (currently always returns success)
  5. Update request status and reply to user
- Users can play as long as they have coins. Coins are earned by matching the golden number.

## OpenAI Integration

- Generate daily 7‑digit golden number at midnight.
- Generate broadcast text when the new number is created: “The new number is ready! Try your luck!”.
- Generate personalized congratulatory text on exact ordered match.

## Admin Panel

- Manage settings: `start_coins`, `withdraw_min_balance`, `deposit_wallet_address`, scoring keys, `sleep_ms_between_rolls`, quiet hours, `openai_model`.
- Manually trigger a new golden number and broadcast to users.
- View users list, coins, and withdraw requests status.

## API & Cron

- Webhook: `public/game.php`
- Daily cron (00:00): `public/cron/generate-golden.php`

## Security & Best Practices

- Use prepared statements; sanitize inputs; hash passwords with bcrypt.
- Store credentials in `.env`. Do not hardcode secrets.
- Enforce HTTPS, disable directory listing, block sensitive files.

## Notes

- Worldcoin docs: https://docs.world.org/
- UX is command‑based only; no inline keyboards.