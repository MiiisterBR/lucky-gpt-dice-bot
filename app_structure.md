# Project Design — Telegram Golden Dice Bot v2 (PHP + MySQL + OpenAI)

## Overview

- Daily “Golden Number” with 7 digits (generated by OpenAI at midnight).
- Users hold in‑app balance named “World Coin”.
- Users start with 1,000 coins; minimum balance to withdraw is 1,001 coins.
- Game sessions produce 7 dice values. Scoring compares the 7 values to the daily golden number.
- UX is command‑based only (no inline keyboards). All code, texts, and messages are in English.

## Commands (text only)

- `/help` — Show help and available commands.
- `/status` — Show coins, current session state (rolled count, last roll), and wallet address.
- `/startgame` — Start a new session (blocked during quiet hours 23:00–00:00; ongoing sessions can finish).
- `/next` — Roll next dice for the active session (up to 7 rolls, with configurable sleep after each roll).
- `/wallet` — If no wallet exists, ask user to send Worldcoin address; if exists, accept a new address to update. Store/update `wallet_address` in DB.
- `/deposit` — Show deposit address configured in Admin settings.
- `/withdraw` — Ask “How many World Coins do you want to withdraw?”, then create a withdraw request; call a test API and reply success/error accordingly.

## Scoring Rules

- Let G be the 7‑digit golden number, and R be the 7 results of the user’s session.
- If 3 digits of R exist in G (order irrelevant) → award `score_match_3` (default 10).
- If 5 digits of R exist in G (order irrelevant) → award `score_match_5` (default 15).
- If all 7 digits exist but order is not exact → award `score_all_unordered` (default 30).
- If all 7 digits match exactly and in the same order → award `score_exact_ordered` (default 10,000).
- Coins name: “World Coin”.

## Daily Golden Number & Quiet Hours

- A new 7‑digit golden number is generated daily at 00:00 via cron or manual trigger in Admin.
- Quiet hours: 23:00–00:00
  - Users cannot start a new session between 23:00 and 00:00.
  - Ongoing sessions can be completed.
  - If a user tries to start during quiet hours, reply “Come back after 00:00.”
- When a new number is generated, broadcast: “The new number is ready! Try your luck!”.
- If a user hits the exact 7‑digit ordered match, send a congratulatory message generated by ChatGPT.

## Technical Details

- Language: PHP 8+
- Database: MySQL
- Entry point: `public/game.php` (Telegram webhook)
- Architecture: Controllers, Services, Repositories, Models (SOLID/SoC)
- No inline keyboards. Rely on commands and plain text prompts.
- Sleep between rolls: `sleep_ms_between_rolls` (default 3000 ms), configurable in settings.

## Database Schema (MySQL)

Implemented in `migrations/game.sql` (re‑import to apply v2):

- `users`: `id`, `username`, `first_name`, `last_name`, `coins` (default 1000), `wallet_address` (unique nullable), timestamps
- `golden_numbers`: `id`, `generated_at`, `number` (CHAR(7)), `valid_date`, `source`, `announced`, timestamps
- `game_sessions`: `id`, `user_id`, `golden_id`, `result_digits` (CHAR(7)), `rolls_count`, `finished`, `score_awarded`, timestamps
- `rolls`: `id`, `session_id`, `user_id`, `result` (1–6), `step_index` (1–7), `cost`, `created_at`
- `withdraw_requests`: `id`, `user_id`, `amount`, `status` (pending/success/failed), `api_response`, timestamps
- `admin_users`: `id`, `username`, `password_hash`, timestamps
- `settings`: key/value store

Seeded settings (can be changed in Admin):
- `openai_model=gpt-5`
- `start_coins=1000`, `withdraw_min_balance=1001`, `deposit_wallet_address` (string)
- `sleep_ms_between_rolls=3000`, `quiet_hours_start=23:00`, `quiet_hours_end=00:00`
- `score_match_3=10`, `score_match_5=15`, `score_all_unordered=30`, `score_exact_ordered=10000`
- `dice_cost=0`, `log_requests=false`

## Folder Structure

```
telegram-game-bot/
├─ public/
│  ├─ game.php
│  └─ cron/generate-golden.php        # run at 00:00 daily
├─ src/
│  ├─ App.php
│  ├─ Controllers/
│  │  └─ TelegramController.php
│  ├─ Services/
│  │  ├─ TelegramService.php
│  │  ├─ OpenAIService.php
│  │  ├─ GameService.php
│  │  └─ UserService.php
│  ├─ Repositories/
│  │  ├─ UserRepository.php
│  │  └─ GoldenRepository.php
│  └─ Models/
│     ├─ User.php
│     ├─ Roll.php
│     └─ Guess.php (legacy; not used in v2)
├─ admin/
│  └─ index.php                      # Dashboard & Settings
├─ migrations/
│  └─ game.sql
├─ .env
├─ composer.json
└─ README.md
```

## Game Flow Summary

1) User sends `/startgame` (blocked 23:00–00:00). A new session is created for the current daily golden number.
2) User sends `/next` up to 7 times; each call rolls a dice (1–6), appends to session, sleeps `sleep_ms_between_rolls` ms, and replies with the current progress (e.g., `3/7 rolled: 2, 6, 4`).
3) When 7 values are collected, compute the score according to the Scoring Rules and add coins to the user.
4) If exact ordered match, generate a personalized congratulatory text with ChatGPT and send it.

## Wallet / Deposit / Withdraw

- `/wallet`: Ask for the user’s Worldcoin address if missing; if supplied again, update it.
- `/deposit`: Return the deposit address from Admin settings.
- `/withdraw`: Ask for an amount (integer). Create a new `withdraw_requests` row and call a stub test API; reply with success/failed accordingly.
- Users can play as long as they have coins. Minimum balance to withdraw is `withdraw_min_balance` (default 1001).

## OpenAI Integration

- Generate daily 7‑digit golden number at midnight.
- Generate broadcast text when the new number is created: “The new number is ready! Try your luck!”.
- Generate personalized congratulatory text on exact ordered match.

## Admin Panel

- Manage settings: `start_coins`, `withdraw_min_balance`, `deposit_wallet_address`, scoring keys, `sleep_ms_between_rolls`, quiet hours, `openai_model`.
- Manually trigger a new golden number and broadcast to users.
- View users list, coins, and withdraw requests status.

## API & Cron

- Webhook: `public/game.php`
- Daily cron (00:00): `public/cron/generate-golden.php`

## Security & Best Practices

- Use prepared statements; sanitize inputs; hash passwords with bcrypt.
- Store credentials in `.env`. Do not hardcode secrets.
- Enforce HTTPS, disable directory listing, block sensitive files.

## Notes

- Worldcoin docs: https://docs.world.org/
- UX is command‑based only; no inline keyboards.